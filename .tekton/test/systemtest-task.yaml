apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: systemtest-task
  labels:
    app: enmasse-test
spec:
  params:
    - name: profile
      type: string
    - name: testcase
      type: string
    - name: kube_api_url
      type: string
    - name: kube_token
      type: string
    - name: kube_namespace
      type: string
    - name: repo_url
      type: string
  steps:
    - name: install-and-setup-packages
      image: gcr.io/cloud-builders/wget:latest
      workingDir: /workspace/
      script: |

        wget "https://mirror.openshift.com/pub/openshift-v4/clients/oc/latest/linux/oc.tar.gz" -q
        tar xf oc.tar.gz

    - name: clone-repo
      image: gcr.io/cloud-builders/git:latest
      workingDir: /workspace
      script: |

        git clone $(inputs.params.repo_url)

    - name: generate-templates
      image: gcr.io/cloud-builders/go:latest
      env:
        - name: GOROOT
          value: /usr/local/go
      workingDir: /workspace/enmasse
      script: |

        make templates

    - name: run-tests
      image: gcr.io/cloud-builders/mvn:latest
      securityContext:
        privileged: true
      command:
        - /bin/bash
      workingDir: /workspace
      args:
        - -c
        - |
          mv oc /usr/bin/oc
          oc login --token $(inputs.params.kube_token) $(inputs.params.kube_api_url) --insecure-skip-tls-verify=true
          export KUBERNETES_NAMESPACE=$(inputs.params.kube_namespace)
          cd enmasse
          mvn test -pl systemtests -am -P$(inputs.params.profile) -Djava.net.preferIPv4Stack=true -DfailIfNoTests=true -Dstyle.color=always -DskipTests --no-transfer-progress -Dtest=$(inputs.params.testcase)

